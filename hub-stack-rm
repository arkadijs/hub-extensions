#!/bin/bash -e

HUB_HOME="${HUB_HOME:-$(dirname "$0")}"
HUB_WORKDIR="${HUB_WORKDIR:-$(pwd)}"
HUB_EXTENSION="$(basename "$0" | sed 's/-/ /g')"
PATH="$HUB_HOME:$HUB_HOME/bin:$HUB_WORKDIR:$HUB_WORKDIR/bin:$PATH"
export PATH HUB_WORKDIR

usage() {
cat << EOF
Remove configuration from current stack

Usage:
  $HUB_EXTENSION [DOMAIN_NAME]

Parameters:
    -V  --verbose          Verbose outputs for debug purpose
    -h --help              Show this message

EOF
}

DOT_ENV=".env"
while [ "$1" != "" ]; do
    case $1 in
    -V | --verbose )    set -x
                        ;;
    -h | --help )       usage
                        exit
                        ;;
    initialized )       DOT_ENV=".hub/env/.env"
                        ;;
    * )                 DOT_ENV=".hub/env/$1.env"
                        ;;
    esac
    shift
done

if test -L "$DOT_ENV" -a ! -e "$DOT_ENV"; then
  echo "* Unlinking: .env"
  unlink "$HUB_WORKDIR/.env"
  exit
fi

if test ! -f "$DOT_ENV"; then
  cat <<EOF | color w
Nothing to remove

EOF
  cat <<EOF | color g

To see list of available stacks run

  hub stack ls

EOF
  exit 1
fi
dotenv="dotenv -f $DOT_ENV"
HUB_DOMAIN_NAME="$($dotenv get "HUB_DOMAIN_NAME")"
if test -z "$HUB_DOMAIN_NAME"; then
  HUB_DOMAIN_NAME="$($dotenv get "HUB_STACK_NAME")"
  if test -L .env; then
    FILES="$FILES $(readlink -n .env)"
  fi
fi

if test -n "$HUB_DOMAIN_NAME"; then
  # shellcheck disable=SC2086
  FILES=$(ls .hub/env/$HUB_DOMAIN_NAME.*)
  echo "Removing configuration for: $HUB_DOMAIN_NAME"
else
  echo "Removing configuration for: initialized"
fi

for key in $(dotenv keys); do
  if test "$key" = "$HUB_WORKDIR" -o "$key" = "$HUB_FILES"; then
    continue
  fi
  for v in $($dotenv get "$key" | sed 's/-/ /g'); do
    if test -f "$v"; then
      FILES="$FILES $v"
    fi
  done
done

for f in $FILES; do
  if ! test -f; then
    color w  "* Skipping $f (not found)"
    continue
  elif test -L "$f"; then
    link="$(readlink -n "$f")"
    if test -f "$link"; then
      echo "* Removing: $link"
      rm -rf "$link"
    fi
    "* Unlinking: $f"
    unlink "$f"
  else
    echo "* Removing: $f"
    rm -rf "$f"
  fi
done

if test -L ".env"; then
  echo "* Unlinking: .env"
  unlink "$HUB_WORKDIR/.env"
fi

color w "This operation does not undeploy associated to the stack resources"
cat << EOF | color g

Stack been removed

EOF
