#!/bin/bash -e

usage() {
  cat <<EOF
GCP access parameters:
      --gcp-project-id               ARG    Override GCP project ID
      --gcp-application-credentials  ARG    Path to the google application credentials file (see: https://cloud.google.com/docs/authentication/getting-started, can be also defined via GOOGLE_APPLICATION_CREDENTIALS)
EOF
}

while [ "$1" != "" ]; do
  case $1 in
  --defaults )
    INTERACTIVE=false
    ;;
  --gcp-project-id )
      shift
      GCP_PROJECT_ID="$1"
      INTERACTIVE=false
      ;;
  --gcp-application-credentials )
      shift
      GOOGLE_APPLICATION_CREDENTIALS="$1"
      ;;
  -h | --help )
      usage
      exit 0
      ;;
  esac
  shift
done

if test "$VERBOSE" = "true"; then
  set -x
fi

dotenv="dotenv -f $HUB_WORKDIR/.env"

VAl_envvar="$GCP_PROJECT_ID"
VAL_gcloud="$(gcloud config get-value project)"

echo "* Setting GCP project ID"

for tag in "env" "gcloud"; do
  val=$(eval echo "\$VAL_$tag")
  if test -n "$val"; then
    hashtag="$tag"
    break;
  fi
done

if ! $INTERACTIVE; then
  VALUE="$val"
elif test "$val" = "$(echo $val | cut -c1-31)"; then
  read -rp "  Enter value ($val #$hashtag): " VALUE
else
  read -rp "  Enter value ($(echo $val | cut -c1-31)... #$hashtag): " VALUE
fi
if test -z "$VALUE"; then
  VALUE="$val"
fi

GCLOUD_OPTS="$GCLOUD_OPTS --project $GCP_PROJECT_ID"

if test -z "$GOOGLE_APPLICATION_CREDENTIALS"; then
  GOOGLE_APPLICATION_CREDENTIALS="~/.config/gcloud/application_default_credentials.json"
  export GOOGLE_APPLICATION_CREDENTIALS

  echo -n "* Checking default credentials: "
  if test -f "$GOOGLE_APPLICATION_CREDENTIALS"; then
    echo "found"
  else
    echo "not found "
    echo "  Proceeding with user login: gcloud auth application-default login ..."
    gcloud "$GCLOUD_OPTS" --no-user-output-enabled auth application-default login

    echo "* Switching gcloud project config to: $PROJECT_ID"
    gcloud "GCLOUD_OPTS" config set project PROJECT_ID
  fi
else
  echo "* Using application credentials: $GOOGLE_APPLICATION_CREDENTIALS"
fi

$dotenv set "GOOGLE_APPLICATION_CREDENTIALS=\"$GOOGLE_APPLICATION_CREDENTIALS\""
$dotenv set "GCP_PROJECT_ID=\"$VALUE\""
echo "  saved as GCP_PROJECT_ID to .env file"
