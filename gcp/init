#!/bin/bash -e

usage() {
  cat <<EOF
GCP access flags:
      --gcp-project-id string                 Override GCP project ID
      --gcp-application-credentials string    Path to the google application credentials file (see: https://cloud.google.com/docs/authentication/getting-started, can be also defined via GOOGLE_APPLICATION_CREDENTIALS)
EOF
}

contains() {
  local pattern result
  pattern="$1"
  shift

  # shellcheck disable=SC2048
  for w in $*; do
    if test "$w" = "$pattern"; then
      result="$w"
      break
    fi
  done
  test -n "$result"
}

ident() {
  sed 's/^/  /'
}

while [ "$1" != "" ]; do
  case $1 in
  --defaults)
    INTERACTIVE=false
    ;;
  --gcp-project-id)
    shift
    GOOGLE_PROJECT="$1"
    INTERACTIVE=false
    ;;
  --gcp-application-credentials)
    shift
    GOOGLE_APPLICATION_CREDENTIALS="$1"
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  esac
  shift
done

if test "$VERBOSE" = "true"; then
  set -x
fi
dotenv="dotenv -f $DOT_ENV"

echo "Setting up access"
if test -n "$GOOGLE_PROJECT"; then
  echo "* Setting GCP project ID: defined via GOOGLE_PROJECT"
else
  echo "* Setting GCP project ID"
  gcloud_result="$(gcloud config list --format="json" | jq -cMr '.core.project | select(.)')"
  if ! $INTERACTIVE; then
    GOOGLE_PROJECT="$gcloud_result"
  elif test -z "$gcloud_result"; then
    read -rp "  Enter value: " GOOGLE_PROJECT
  elif test "$gcloud_result" = "$(echo "$gcloud_result" | cut -c1-31)"; then
    echo -n "  Enter value ("
    color -n b "$gcloud_result"
    read -rp " #gcloud): " GOOGLE_PROJECT
  else
    echo -n "  Enter value ("
    color -n b "$(echo "$gcloud_result" | cut -c1-31)..."
    read -rp " #gcloud): " GOOGLE_PROJECT
  fi
  if test -z "$GOOGLE_PROJECT"; then
    GOOGLE_PROJECT="$gcloud_result"
  fi
fi

if test -z "$GOOGLE_PROJECT"; then
  cat << EOF

Abort due: project ID has not been defined
To correct this error run again:
  $HUB_EXTENSION

EOF
  exit 2
fi

active_projects="$(gcloud projects list --format='json' | jq -cMr '[.[]][] | select(.lifecycleState == "ACTIVE").projectId | select(.)')"
if ! contains "$GOOGLE_PROJECT" "$active_projects"; then
    cat <<EOF | ident | color warn
Warning: entered GCP project ID has not been listed in active projects.
This may be a simiple typo or intentionally

List of active projects:
$active_projects

Entered value: $GOOGLE_PROJECT

EOF
fi

$dotenv set "GOOGLE_PROJECT=\"$GOOGLE_PROJECT\""
# deprecated variable as not recognized by Terraform
# see: https://registry.terraform.io/providers/hashicorp/google/3.29.0/docs/guides/provider_reference
$dotenv set "GCP_PROJECT_ID=\"$GOOGLE_PROJECT\""

if test -z "$GOOGLE_APPLICATION_CREDENTIALS"; then
  CREDS="$HOME/.config/gcloud/application_default_credentials.json"
  if curl -H "Metadata-Flavor: Google" "http://metadata.google.internal" -i >/dev/null 2>&1; then
    echo "* The Hub CLI runs inside a Google Cloud environment using Environment-provided service account to talk to GCP"
  elif test -f "$CREDS"; then
    echo "* $CREDS file exists"
    echo "  ADC (Application Default Credentials) will be used to authenticate requests to GCP"
  else
    echo "* Since GOOGLE_APPLICATION_CREDENTIALS is not provided"
    echo "  trying ADC (Application Default Credentials) to authenticate"
    echo "  please give consent in the browser"
    if gcloud auth application-default login >/dev/null 2>&1; then
      echo "* Consent has been given. $CREDS created"
    else
      echo "gcloud auth application-default login command failed"
      exit 1
    fi
  fi
else
  echo "* Using application credentials: $GOOGLE_APPLICATION_CREDENTIALS"
  $dotenv set "GOOGLE_APPLICATION_CREDENTIALS=\"$GOOGLE_APPLICATION_CREDENTIALS\""
fi
