#!/bin/bash -e
# shellcheck disable=SC2046,SC2086,SC2034

usage() {
  cat << EOF
Environment variables parameters:
  -f --file               Path to hub.yaml or parameter files (can repeat multiple times; default: hub.yaml params.yaml)
  --defaults              Do not ask for usecr input and accept default values instead
EOF
}

ident() {
  sed 's/^/  /'
}

if test -n "$(which tty)" && tty -s || echo "$-" | grep 'i'; then
  INTERACTIVE=true
else
  INTERACTIVE=false
fi

while [ "$1" != "" ]; do
  case $1 in
    --defaults )
      INTERACTIVE=false
      ;;
    --output )
      shift
      DOT_ENV="$1"
      ;;
    -f | --file )
      shift
      HUB_FILES="$(echo "$HUB_FILES $1" | xargs)"
      ;;
    -h | --help )
      usage
      exit
      ;;
  esac
  shift
done

if test -z "$HUB_WORKDIR"; then
  FIRST_FILE="$(echo "$HUB_FILES" | awk '{print $1;}')"
  if test -f $FIRST_FILE; then
    HUB_WORKDIR="$(dirname "$FIRST_FILE")"
  else
    HUB_WORKDIR="$(pwd)"
  fi
  export HUB_WORKDIR
fi

jq="jq -cMr"

HISTORY_FILE="$HUB_WORKDIR/.hub/env/.history"
mkdir -p "$(dirname "$HISTORY_FILE")"
touch "$HISTORY_FILE"
history="dotenv -f $HISTORY_FILE"

if test $VERBOSE = "true"; then
  set -x
fi

if test -z "$HUB_FILES"; then
  echo "Error: cannot find stack definition files"
  exit 1
fi

echo "Configuring environment variables"
# ALL_ENVS=
# for f in $HUB_FILES; do
#   test -f "$f" || continue;
#   envs=$(
#     yq e $f -o=json | jq -cr \
#       '.. | objects | with_entries(select(.key=="fromEnv")).fromEnv? | select(.!=null)'
#   )
#   ALL_ENVS="$ALL_ENVS $envs"
# done

if test -z "$DOT_ENV"; then
  echo "Error: please run with option: $(dirname "0")/$(basename "0") --output FILE "
  exit 2
fi

touch $DOT_ENV
for ENV in $(params listenv); do
  json=$(params envvar "$ENV")
  if test -z "$json"; then
    color warn "* Warning: cannot find parameter for variable: $ENV"
    continue
  fi

  VALUE=$(printenv "$ENV" || echo "")
  PARAM=$(echo "$json" | $jq '.name  | select (.)')
  BRIEF=$(echo "$json" | $jq '.brief | select (.)')
  if test -z "$VALUE"; then
    echo -n "* Parameter: "
    color h "$PARAM"
    if test -n "$BRIEF"; then
      echo "$BRIEF" | ident
    fi
    VAL_default=$(echo "$json" | $jq '.default | select (.)')
    VAL_hubstate=$(hub show -q ".parameters.$PARAM" -- -rM 2>/dev/null || echo "")
    VAL_history=$($history get $ENV)
    VAL_random=$(uuidgen | tr '[:upper:]' '[:lower:]' | tr -d -)
    VAL_empty=""
    EMPTY=$(echo "$json" | $jq '.empty | select (.)')
    if test "$EMPTY" = "allow"; then
      HASHTAGS="hubstate default empty"
    else
      HASHTAGS="hubstate history default random"
    fi
    for t in $HASHTAGS; do
      val=$(eval echo "\$VAL_$t")
      if test -n "$val" || test "$t" = "empty"; then
        hashtag="$t"
        break;
      fi
    done

    if ! $INTERACTIVE; then
      VALUE="$val"
    elif test -z "$val"; then
      read -rp "  Enter value: " VALUE
    elif test "$val" = "$(echo $val | cut -c1-31)"; then
      echo -n "  Enter value ("
      color -n b "$val"
      read -rp " #$hashtag): " VALUE
    else
      echo -n "  Enter value ("
      color -n b "$(echo "$val" | cut -c1-31)..."
      read -rp " #$hashtag): " VALUE
    fi
    if test -n "$VALUE"; then
      $history set "$ENV=\"$VALUE\""
    else
      VALUE="$val"
    fi
  else
    echo -n "* Parameter: "
    color h "$PARAM"
    color -n h "  $ENV "
    echo "already exist"
    continue
  fi
  echo "$ENV=\"$VALUE\"" >> $DOT_ENV
  echo -n "  saved as "
  color -n b "$ENV"
  echo " to .env file"
done
